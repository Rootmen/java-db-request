<?xml version="1.0" encoding="UTF-8"?>
<Definitions>

    <!-- QuerySet это набор запросов QUERY, ID в QuerySet его уникальное имя -->
    <QuerySet ID="ASOUV_ERROR">
        <!-- QUERY является самим запросом -->
        <QUERY>
            <!-- CONNECTION - это то подключение к БД которое мы будем импользовать -->
            <!-- <CONNECTION refid="TEST_EDB_con"/> -->
            <!-- TextParam - параметр запроса name="ERROR_STR" это то как мы будем его называть в SQL при вставке
            В случе если напсать так

                <TextParam refid="ERROR_STR" 	name="ERROR_STR">

            то данное значение будет использовано как есть,
            однако есть возможность использовать параметр when для конкретных случаев и otherwise для всех остальных

            <TextParam refid="DATA" name="DATA">
                <when value="M" >OP.create_data BETWEEN (current_date - interval '1 mon') and (current_date + interval '1 day')</when>
                <when value="Y" >OP.create_data BETWEEN (current_date - interval '1 year') and (current_date + interval '1 day')</when>
                <when value="ALL" >true</when>
                <when value="" >true</when>
                <when value="," >true</when>
                <otherwise>OP.create_data BETWEEN ? </otherwise>
            </TextParam>

            Еще в качестве TextParam можно использовать QUERY который будет выполнять другией запросы и меть свои TextParam которые можно позаимствовать у основного запроса
            <TextParam refid="TYPE" name="PATCH_LIST">
                <QUERY>
                    <TextParam refid="ST_NZ" name="ST_NZ">
                        <when value="">NULL</when>
                        <when value="undefined">NULL</when>
                        <otherwise>?</otherwise>
                    </TextParam>
                    /........../
                </QUERY>
            </TextParam>
            -->
            <TextParam refid="ERROR_STR" 	name="ERROR_STR">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="USER_AGENT" 	name="USER_AGENT">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="LAST_LOG" 	name="LAST_LOG">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="USER_NAME" 	name="USER_NAME">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="USER_ID" 		name="USER_ID">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="APP_NAME" 	name="APP_NAME">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="STAK_TRASE" 	name="STAK_TRASE">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="URL" 			name="URL">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>
            <TextParam refid="SERVER" 			name="SERVER">
                <when value="">NULL</when>
                <when value="undefined">NULL</when>
                <when value="null">NULL</when>
                <otherwise>'?'</otherwise>
            </TextParam>

            <!-- Type имеет два варианта значений setSQL/getSQL getSQL запросы не выполняют операции модификации или добавления данных,
                 а setSQL не возращают данные
              -->
            <Type>setSQL</Type>
            <!-- ResultType определяет формат данных которй мы получим на выходе JSON_Q - возращает JSON а XML - xml
              -->
            <ResultType>text</ResultType>
            <!-- Text это сам SQL запрос, используя $ИМЯ_TextParam$ в нем можно ссылатся на TextParam, "<![CDATA[" и "]]>" используются для экранирования значений  -->
            <Text>
                <![CDATA[
				CREATE TEMPORARY TABLE TT (ID INT);
				WITH ID AS (INSERT INTO DBLOGGER.WEB_LOGGING (APP, ERROR_STR, USER_AGENT, LAST_LOG, USER_NAME, USER_ID, STAK_TRASE, URL, SERVER, TIME)
				VALUES ($APP_NAME$, $ERROR_STR$, $USER_AGENT$, $LAST_LOG$, $USER_NAME$, $USER_ID$, $STAK_TRASE$, $URL$, $SERVER$, CURRENT_TIMESTAMP) RETURNING ID)
				INSERT INTO TT SELECT ID.ID FROM ID;
				]]>
            </Text>
            <!-- <Execute/> запускает выполнение запроса <Execute>DEBUG_SQL</Execute> вместо выполнения запроса вернет сам SQL кодициц -->
            <Execute/>
            <ResultType>JSON_Q</ResultType>
            <Type>getSQL</Type>
            <Text>
                <![CDATA[
				SELECT 'OK' AS STATUS, * FROM TT;
				]]>
            </Text>
            <Execute/>
        </QUERY>
    </QuerySet>


    <QuerySet ID="GET_MAX_ID_ERROR">
        <QUERY>
            <CONNECTION refid="TEST_EDB_con"/>
            <Type>getSQL</Type>
            <ResultType>text</ResultType>
            <Text>
                <![CDATA[
				SELECT MAX(ID) FROM DBLOGGER.WEB_LOGGING;
				]]>
            </Text>
            <Execute/>
        </QUERY>
    </QuerySet>


</Definitions>